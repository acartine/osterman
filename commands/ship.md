---
description: Ship changes by committing, pushing, creating PR, and auto-merging
argument-hint: [DESC="<commit-description>"]
allowed-tools: Bash(git:*), Bash(gh:*), Task
model: sonnet
---

# Ship Command

Ship your local changes quickly by:
1. Creating a branch (if on main), or using current branch
2. Committing all local edits
3. Pushing to remote
4. Creating a PR
5. Reviewing and auto-merging (if ready)

## Task
Automate the complete flow from local changes to merged PR.

## Arguments
User provided: $ARGUMENTS

Expected format:
- `ship` - Use auto-generated commit message from git diff
- `ship DESC="<description>"` - Use custom commit description

## Instructions

### 1. Parse Arguments
- Extract DESC if provided, otherwise will use auto-generated message based on changes
- Auto-detect repository from git remote:
  ```bash
  git remote get-url origin | sed -E 's#.*[:/](.+/.+)\.git#\1#'
  ```

### 2. Check Current Branch
- Get current branch: `git branch --show-current`
- Store as CURRENT_BRANCH
- Determine if branch creation needed:
  - If CURRENT_BRANCH == "main": Set CREATE_BRANCH=true
  - Otherwise: Set CREATE_BRANCH=false, use CURRENT_BRANCH

### 3. Create Branch (if needed)
- If CREATE_BRANCH==true:
  - Generate branch name from DESC or timestamp
  - Example: `feature/ship-$(date +%Y%m%d-%H%M%S)` or `feature/<desc-kebab-case>`
  - Create and checkout: `git checkout -b <branch-name>`

### 4. Commit Changes
- Check for uncommitted changes: `git status --porcelain`
- If changes exist:
  - Stage all changes: `git add -A`
  - Generate commit message:
    - If DESC provided: Use DESC as commit message
    - Otherwise: Generate from git diff summary
  - Commit: `git commit -m "<commit-message>"`
- If no changes:
  - Check if there are unpushed commits: `git log origin/$(git branch --show-current)..HEAD`
  - If no unpushed commits, inform user: "No changes to ship"
  - Exit

### 5. Push to Remote
- Push with upstream tracking:
  ```bash
  git push -u origin $(git branch --show-current)
  ```

### 6. Create PR (if doesn't exist)
- Check if PR already exists: `gh pr view --json number 2>/dev/null`
- If PR doesn't exist:
  - Create PR with auto-generated body:
    ```bash
    gh pr create --title "<commit-title>" --body "$(cat <<'EOF'
    ## Summary
    <auto-generated from commits>

    ## Test Plan
    - [ ] Manual verification
    - [ ] CI checks passing

    ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
    EOF
    )"
    ```
  - Capture PR number from output

### 7. Review and Merge
- Get PR number from step 6 or from existing PR
- Invoke tl agent for review_and_merge:
  - Use Task tool with subagent_type="tl"
  - Pass prompt: "review_and_merge PR=<num> REPO=<org/name>"
  - This will:
    - Review the PR
    - Auto-merge if ready and CI is green
    - Monitor for updates if changes needed

## Safety Guardrails

- NEVER force push
- NEVER skip CI checks
- ALWAYS verify current state before proceeding
- If on main with no changes, warn user
- If PR already merged, inform user

## Examples

**Ship with auto-generated message:**
```
/ship
```

**Ship with custom description:**
```
/ship DESC="fix: correct login redirect logic"
```

**Common scenarios:**
```
# Quick ship after making changes
/ship

# Ship with descriptive commit
/ship DESC="feat: add user profile export"

# Ship bug fix
/ship DESC="fix: prevent null pointer in payment flow"
```

## Reference Documentation
- **Commands**: `commands/jswe.md` for implementation flow, `commands/tl.md` for review/merge
- **Skills**: `skills/gh_pr_view.md`, `skills/gh_pr_merge.md`
- **CLAUDE.md**: Agent Development Flow section
